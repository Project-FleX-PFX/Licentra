<% @title = "Raw Data Overview" %>

<h1 class="text-start">Raw Data Overview</h1>
<p class="page-description text-start">A raw view of all data tables in the system.</p>

<div class="card mt-4">
  <div class="card-header">
    <h2 class="h5 mb-0">Products (<%= @products.count %>)</h2>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped table-hover table-sm mb-0">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Product Name</th>
          </tr>
        </thead>
        <tbody>
          <% @products.each do |p| %>
            <tr>
              <td><%= p.product_id %></td>
              <td>
                <% if p.product_name.nil? || p.product_name.empty? %>
                  <span class="text-muted fst-italic">N/A</span>
                <% else %>
                  <%= p.product_name %>
                <% end %>
              </td>
            </tr>
          <% end %>
          <% if @products.empty? %>
            <tr><td colspan="2" class="text-center text-muted">No products found.</td></tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="card mt-4">
  <div class="card-header">
    <h2 class="h5 mb-0">License Types (<%= @license_types.count %>)</h2>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped table-hover table-sm mb-0">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Type Name</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          <% @license_types.each do |lt| %>
            <tr>
              <td><%= lt.license_type_id %></td>
              <td>
                <% if lt.type_name.nil? || lt.type_name.empty? %>
                  <span class="text-muted fst-italic">N/A</span>
                <% else %>
                  <%= lt.type_name %>
                <% end %>
              </td>
              <td>
                <% if lt.description.nil? || lt.description.empty? %>
                  <span class="text-muted fst-italic">N/A</span>
                <% else %>
                  <%= lt.description %>
                <% end %>
              </td>
            </tr>
          <% end %>
          <% if @license_types.empty? %>
            <tr><td colspan="3" class="text-center text-muted">No license types found.</td></tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="card mt-4">
  <div class="card-header">
    <h2 class="h5 mb-0">Roles (<%= @roles.count %>)</h2>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped table-hover table-sm mb-0">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Role Name</th>
          </tr>
        </thead>
        <tbody>
          <% @roles.each do |r| %>
            <tr>
              <td><%= r.role_id %></td>
              <td>
                <% if r.role_name.nil? || r.role_name.empty? %>
                  <span class="text-muted fst-italic">N/A</span>
                <% else %>
                  <%= r.role_name %>
                <% end %>
              </td>
            </tr>
          <% end %>
          <% if @roles.empty? %>
            <tr><td colspan="2" class="text-center text-muted">No roles found.</td></tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="card mt-4">
  <div class="card-header">
    <h2 class="h5 mb-0">Users (<%= @users.count %>)</h2>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped table-hover table-sm mb-0">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Username</th>
            <th>E-Mail</th>
            <th>Name</th>
            <th>Active?</th>
            <th>Password Set?</th>
            <th>Roles</th>
          </tr>
        </thead>
        <tbody>
          <% @users.each do |u| %>
            <tr>
              <td><%= u.user_id %></td>
              <td>
                <% if u.username.nil? || u.username.empty? %>
                  <span class="text-muted fst-italic">N/A</span>
                <% else %>
                  <%= u.username %>
                <% end %>
              </td>
              <td>
                <% if u.email.nil? || u.email.empty? %>
                  <span class="text-muted fst-italic">N/A</span>
                <% else %>
                  <%= u.email %>
                <% end %>
              </td>
              <td>
                <% name = [u.first_name, u.last_name].compact.join(' ') %>
                <% if name.empty? %>
                  <span class="text-muted fst-italic">N/A</span>
                <% else %>
                  <%= name %>
                <% end %>
              </td>
              <td>
                <span class="badge <%= u.is_active ? 'bg-success' : 'bg-danger' %>"><%= u.is_active ? 'Yes' : 'No' %></span>
              </td>
              <td>
                <span class="badge <%= u.credential ? 'bg-success' : 'bg-danger' %>"><%= u.credential ? 'Yes' : 'No' %></span>
              </td>
              <td>
                <% if u.roles.any? %>
                  <%= u.roles.map(&:role_name).join(', ') %>
                <% else %>
                  <span class="text-muted fst-italic">None</span>
                <% end %>
              </td>
            </tr>
          <% end %>
          <% if @users.empty? %>
            <tr><td colspan="7" class="text-center text-muted">No users found.</td></tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="card mt-4">
  <div class="card-header">
    <h2 class="h5 mb-0">Devices (<%= @devices.count %>)</h2>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped table-hover table-sm mb-0">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Device Name</th>
            <th>Serial Number</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody>
          <% @devices.each do |d| %>
            <tr>
              <td><%= d.device_id %></td>
              <td>
                <% if d.device_name.nil? || d.device_name.empty? %>
                  <span class="text-muted fst-italic">N/A</span>
                <% else %>
                  <%= d.device_name %>
                <% end %>
              </td>
              <td>
                <% if d.serial_number.nil? || d.serial_number.empty? %>
                  <span class="text-muted fst-italic">N/A</span>
                <% else %>
                  <%= d.serial_number %>
                <% end %>
              </td>
              <td>
                <% if d.notes.nil? || d.notes.empty? %>
                  <span class="text-muted fst-italic">N/A</span>
                <% else %>
                  <%= d.notes %>
                <% end %>
              </td>
            </tr>
          <% end %>
          <% if @devices.empty? %>
            <tr><td colspan="4" class="text-center text-muted">No devices found.</td></tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="card mt-4">
  <div class="card-header">
    <h2 class="h5 mb-0">Licenses (<%= @licenses.count %>)</h2>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped table-hover table-sm mb-0" style="min-width: 800px;">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Name / Key</th>
            <th>Product</th>
            <th>Type</th>
            <th>Seats</th>
            <th>Available</th>
            <th>Purchase Dt.</th>
            <th>Expire Dt.</th>
            <th>Cost</th>
            <th>Vendor</th>
            <th>Status</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody>
          <% @licenses.each do |l| %>
            <tr>
              <td><%= l.license_id %></td>
              <td>
                <strong>
                  <% if l.license_name.nil? || l.license_name.empty? %>
                    <span class="text-muted fst-italic">No Name</span>
                  <% else %>
                    <%= l.license_name %>
                  <% end %>
                </strong><br>
                <small>Key: <code>
                  <% if l.license_key.nil? || l.license_key.empty? %>
                    <span class="text-muted fst-italic">N/A</span>
                  <% else %>
                    <%= l.license_key %>
                  <% end %>
                </code></small>
              </td>
              <td>
                <% if l.product&.product_name.nil? || l.product&.product_name.empty? %>
                  <span class="text-muted fst-italic">Deleted?</span>
                <% else %>
                  <%= l.product.product_name %>
                <% end %>
              </td>
              <td>
                <% if l.license_type&.type_name.nil? || l.license_type&.type_name.empty? %>
                  <span class="text-muted fst-italic">Deleted?</span>
                <% else %>
                  <%= l.license_type.type_name %>
                <% end %>
              </td>
              <td><%= l.seat_count %></td>
              <td><%= l.available_seats %></td>
              <td>
                <% if l.purchase_date %>
                  <%= l.purchase_date.strftime('%Y-%m-%d') %>
                <% else %>
                  <span class="text-muted fst-italic">N/A</span>
                <% end %>
              </td>
              <td>
                <% if l.expire_date %>
                  <%= l.expire_date.strftime('%Y-%m-%d') %>
                <% else %>
                  <span class="text-muted fst-italic">Unlimited</span>
                <% end %>
              </td>
              <td>
                <% if l.cost %>
                  <%= "#{l.cost.to_f.round(2)} #{l.currency || ''}" %>
                <% else %>
                  <span class="text-muted fst-italic">N/A</span>
                <% end %>
              </td>
              <td>
                <% if l.vendor.nil? || l.vendor.empty? %>
                  <span class="text-muted fst-italic">N/A</span>
                <% else %>
                  <%= l.vendor %>
                <% end %>
              </td>
              <td>
                <% 
                  status_class = 'bg-secondary'
                  status_text = l.status.nil? || l.status.empty? ? 'Unknown' : l.status
                  if status_text.downcase == 'active'
                    status_class = 'bg-success'
                  elsif status_text.downcase == 'expired'
                    status_class = 'bg-warning text-dark'
                  end
                %>
                <span class="badge <%= status_class %>"><%= status_text %></span>
              </td>
              <td>
                <% if l.notes.nil? || l.notes.empty? %>
                  <span class="text-muted fst-italic">N/A</span>
                <% else %>
                  <%= l.notes %>
                <% end %>
              </td>
            </tr>
          <% end %>
          <% if @licenses.empty? %>
            <tr><td colspan="12" class="text-center text-muted">No licenses found.</td></tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="card mt-4">
  <div class="card-header">
    <h2 class="h5 mb-0">License Assignments (<%= @assignments.count %>)</h2>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped table-hover table-sm mb-0" style="min-width: 700px;">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>License</th>
            <th>Assigned To</th>
            <th>Assignment Dt.</th>
            <th>Expire Dt.</th>
            <th>Active?</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody>
          <% @assignments.each do |a| %>
            <tr>
              <td><%= a.assignment_id %></td>
              <td>
                <% if a.license&.license_name.nil? || a.license&.license_name.empty? %>
                  <span class="text-muted fst-italic">License Deleted?</span>
                <% else %>
                  <%= a.license.license_name %>
                <% end %><br>
                <small class="text-muted">(ID: <%= a.license_id %>)</small>
              </td>
              <td>
                <% if a.user %>
                  User: 
                  <% if a.user.username.nil? || a.user.username.empty? %>
                    <span class="text-muted fst-italic">N/A</span>
                  <% else %>
                    <%= a.user.username %>
                  <% end %>
                  <small class="text-muted">(ID: <%= a.user_id %>)</small>
                <% elsif a.device %>
                  Device: 
                  <% if a.device.device_name.nil? || a.device.device_name.empty? %>
                    <span class="text-muted fst-italic">N/A</span>
                  <% else %>
                    <%= a.device.device_name %>
                  <% end %>
                  <small class="text-muted">(ID: <%= a.device_id %>)</small>
                <% else %>
                  <span class="text-muted fst-italic">Orphaned?</span>
                <% end %>
              </td>
              <td>
                <% if a.assignment_date %>
                  <%= a.assignment_date.strftime('%Y-%m-%d %H:%M') %>
                <% else %>
                  <span class="text-muted fst-italic">N/A</span>
                <% end %>
              </td>
              <td>
                <% if a.assignment_expire_date %>
                  <%= a.assignment_expire_date.strftime('%Y-%m-%d %H:%M') %>
                <% else %>
                  <span class="text-muted fst-italic">Unlimited</span>
                <% end %>
              </td>
              <td>
                <span class="badge <%= a.is_active ? 'bg-success' : 'bg-danger' %>"><%= a.is_active ? 'Yes' : 'No' %></span>
              </td>
              <td>
                <% if a.notes.nil? || a.notes.empty? %>
                  <span class="text-muted fst-italic">N/A</span>
                <% else %>
                  <%= a.notes %>
                <% end %>
              </td>
            </tr>
          <% end %>
          <% if @assignments.empty? %>
            <tr><td colspan="7" class="text-center text-muted">No assignments found.</td></tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="card mt-4">
  <div class="card-header">
    <h2 class="h5 mb-0">Assignment Logs (<%= @logs.count %>)</h2>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped table-hover table-sm mb-0" style="min-width: 800px;">
        <thead class="table-light">
          <tr>
            <th>Log ID</th>
            <th>User</th>
            <th>License</th>
            <th>Timestamp</th>
            <th>Action</th>
            <th>Object</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
          <% @logs.each do |log| %>
            <tr>
              <td><%= log.log_id %></td>
              <td>
                <%= log.username %>
                <small class="text-muted">(ID: <%= log.user_id %>)</small>
              </td>
              <td>
                <%= log.license_name %>
                <small class="text-muted">(ID: <%= log.license_id %>)</small>
              </td>
              <td>
                <%= log.log_timestamp.strftime('%Y-%m-%d %H:%M:%S') %>
              </td>
              <td>
                <code><%= log.action %></code>
              </td>
              <td>
                <%= log.object %>
              </td>
              <td class="small">
                <% if log.details.nil? || log.details.empty? %>
                  <span class="text-muted fst-italic">N/A</span>
                <% else %>
                  <%= log.details %>
                <% end %>
              </td>
            </tr>
          <% end %>
          <% if @logs.empty? %>
            <tr><td colspan="7" class="text-center text-muted">No logs found.</td></tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>


<div class="card mt-4">
  <div class="card-header">
    <h2 class="h5 mb-0">Security Logs (<%= @security_logs.count %>)</h2>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped table-hover table-sm mb-0">
        <thead class="table-light">
          <tr>
            <th>Log ID</th>
            <th>Timestamp</th>
            <th>Benutzer</th>
            <th>Aktion</th>
            <th>Objekt</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
          <% @security_logs.each do |log| %>
            <tr>
              <td><%= log.log_id %></td>
              <td>
                <% if log.log_timestamp %>
                  <%= log.log_timestamp.strftime('%Y-%m-%d %H:%M:%S') %>
                <% else %>
                  <span class="text-muted fst-italic">N/A</span>
                <% end %>
              </td>
              <td>
                <% if log.username && log.user_id %>
                  <%= log.username %> (ID: <%= log.user_id %>)
                  <% if log.email %>
                    <br><small class="text-muted"><%= log.email %></small>
                  <% end %>
                <% elsif log.username # Speziell für 'System' oder 'Unknown' User ohne ID/Mail in manchen Fällen %>
                  <%= log.username %>
                <% else %>
                  <span class="text-muted fst-italic">Benutzerinformation nicht verfügbar</span>
                <% end %>
              </td>
              <td>
                <code>
                  <% if log.action.nil? || log.action.empty? %>
                    <span class="text-muted fst-italic">N/A</span>
                  <% else %>
                    <%= log.action %>
                  <% end %>
                </code>
              </td>
              <td>
                <% if log.object.nil? || log.object.empty? %>
                  <span class="text-muted fst-italic">N/A</span>
                <% else %>
                  <%= log.object %>
                <% end %>
              </td>
              <td class="small">
                <% if log.details.nil? || log.details.empty? %>
                  <span class="text-muted fst-italic">N/A</span>
                <% else %>
                  <%= log.details %>
                <% end %>
              </td>
            </tr>
          <% end %>
          <% if @security_logs.empty? %>
            <tr><td colspan="6" class="text-center text-muted">Keine Security Logs gefunden.</td></tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>
